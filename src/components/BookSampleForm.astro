---
interface Props {
  title?: string;
  description?: string;
  buttonText?: string;
  successMessage?: string;
  variant?: 'default' | 'callout';
}

const {
  title = '',
  description = 'Get free chapters',
  buttonText = 'Get free chapters',
  successMessage = 'Check your email for the download link!',
  variant = 'default'
} = Astro.props;

const wrapperClasses = ['book-sample'];
if (variant === 'default') {
  wrapperClasses.push('book-sample--panel');
} else {
  wrapperClasses.push('book-sample--callout');
}
---

<div class:list={wrapperClasses}>
  {title && (
    <h3 class="h3 book-sample__title">
      {title}
    </h3>
  )}
  {description && (
    <p class="body-lg book-sample__description">
      {description}
    </p>
  )}
  <div id="book-form-container">
    <form
      class="book-sample__form"
      id="book-sample-form"
      autocomplete="off"
    >
      <input
        class="book-sample__input"
        name="email_address"
        aria-label="Email Address"
        placeholder="Enter your email"
        required
        type="email"
        id="book-email-input"
      >
      <button
        type="submit"
        class="book-sample__button"
        id="book-submit-button"
      >
        <span class="button-text">{buttonText}</span>
        <span class="button-loading" aria-hidden="true">
          <svg class="book-sample__spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Subscribing...
        </span>
      </button>
    </form>
    <div id="book-form-message" class="book-sample__message" role="status" aria-live="polite"></div>
  </div>
</div>

<script>
if (typeof window !== 'undefined') {
    const form = document.getElementById('book-sample-form') as HTMLFormElement | null;
    const submitButton = document.getElementById('book-submit-button') as HTMLButtonElement | null;
    const buttonText = submitButton?.querySelector('.button-text') as HTMLElement | null;
    const buttonLoading = submitButton?.querySelector('.button-loading') as HTMLElement | null;
    const formMessage = document.getElementById('book-form-message') as HTMLDivElement | null;
    const emailInput = document.getElementById('book-email-input') as HTMLInputElement | null;
    
    let isSubmitting = false;
    let submissionTimeout: number;

    if (form && submitButton && buttonText && buttonLoading && formMessage && emailInput) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isSubmitting) return;
            isSubmitting = true;
            
            // Show loading state
            submitButton!.disabled = true;
            buttonText!.classList.add('is-hidden');
            buttonLoading!.classList.add('is-visible');
            formMessage.classList.remove('is-visible');

            // Set a timeout for user feedback
            submissionTimeout = window.setTimeout(() => {
                resetForm();
                showMessage('Subscription is taking longer than expected. Please check your email for confirmation.', 'warning');
            }, 8000);

            try {
                const formData = new FormData(form);
                
                const response = await fetch('https://app.kit.com/forms/8347970/subscriptions', {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });

                clearTimeout(submissionTimeout);

                // Since we're using no-cors, we can't read the response
                // But if no error is thrown, assume success
                
                // Track successful book sample download in Fathom
                if (typeof (window as any).fathom !== 'undefined') {
                    (window as any).fathom.trackEvent('Book Sample Download');
                }
                
                showMessage('Check your email for the download link!', 'success');
                emailInput.value = '';
                resetForm();

            } catch (error) {
                clearTimeout(submissionTimeout);
                console.error('Form submission error:', error);
                showMessage('Failed to subscribe. Please try again.', 'error');
                resetForm();
            }
        });

        function resetForm() {
            isSubmitting = false;
            submitButton!.disabled = false;
            buttonText!.classList.remove('is-hidden');
            buttonLoading!.classList.remove('is-visible');
        }

        /**
         * Show a message in the form message area.
         * @param {string} message
         * @param {'success' | 'error' | 'warning'} type
         */
        function showMessage(message: string, type: 'success' | 'error' | 'warning') {
            if (!formMessage) return;
            formMessage.textContent = message;
            formMessage.dataset.state = type;
            formMessage.classList.add('is-visible');
        }

        submitButton.addEventListener('click', (e) => {
            if (isSubmitting) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }
}
</script> 

<style>
  .book-sample {
    display: grid;
    gap: 16px;
    border-radius: 10px;
  }

  .book-sample--panel {
    background: rgb(var(--color-surface));
    border: 1px solid rgb(var(--color-border));
    padding: 32px;
  }

  .book-sample--callout {
    padding: 0;
  }

  .book-sample__title {
    margin: 0;
  }

  .book-sample__description,
  .book-sample__note {
    margin: 0;
    color: rgb(var(--color-text));
  }

  .book-sample__note {
    color: rgb(var(--color-text-muted));
  }

  .book-sample__form {
    display: grid;
    gap: 12px;
  }

  @media (min-width: 640px) {
    .book-sample__form {
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: center;
      gap: 16px;
    }
  }

  .book-sample__input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 4px;
    border: 1px solid rgb(var(--color-border));
    background: rgb(var(--color-surface));
    font-size: 1rem;
    line-height: 1.5rem;
    color: rgb(var(--color-text));
  }

  .book-sample__input::placeholder {
    color: rgb(var(--color-text-soft));
  }

  .book-sample__input:focus {
    outline: 2px solid rgba(var(--color-accent), 0.4);
    outline-offset: 2px;
  }

  .book-sample__button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 4px;
    border: none;
    background: rgb(var(--color-accent));
    color: #ffffff;
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.5rem;
    cursor: pointer;
    transition: opacity 150ms ease;
    white-space: nowrap;
  }

  .book-sample__button:hover {
    opacity: 0.9;
  }

  .book-sample__button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .button-loading {
    display: none;
    align-items: center;
    gap: 8px;
  }

  .button-loading.is-visible {
    display: inline-flex;
  }

  .button-text.is-hidden {
    display: none;
  }

  .book-sample__spinner {
    height: 20px;
    width: 20px;
    animation: book-sample-spin 1s linear infinite;
  }

  .book-sample__message {
    font-size: 0.875rem;
    line-height: 1.4;
    margin-top: 8px;
    display: none;
  }

  .book-sample__message.is-visible {
    display: block;
  }

  .book-sample__message[data-state='success'] {
    color: rgb(var(--color-accent));
  }

  .book-sample__message[data-state='error'] {
    color: #d64545;
  }

  .book-sample__message[data-state='warning'] {
    color: #f59e0b;
  }

  @keyframes book-sample-spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>