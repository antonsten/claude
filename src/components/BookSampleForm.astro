---
interface Props {
    title?: string;
    description?: string;
    buttonText?: string;
    successMessage?: string;
}

const { 
    title = "",
    description = "Get free chapters",
    buttonText = "Get free chapters",
    successMessage = "Check your email for the download link!"
} = Astro.props;
---

<div class="bg-light-green/80 dark:bg-dark-surface/80 border border-green/20 dark:border-dark-accent/20 p-8 rounded-[4px]">
    {title && (
        <h3 class="text-black dark:text-dark-text mb-4 text-[20px] leading-[26px] tracking-[-0.01em] font-semibold">
            {title}
        </h3>
    )}
    <p class="text-black dark:text-dark-text mb-4 text-[20px] leading-[26px] tracking-[-0.01em] font-regular">
        {description}
    </p>
    <p class="text-black dark:text-dark-text mb-8 text-[16px] leading-[22px] tracking-[-0.01em] font-regular">
        No catch. Just good content (chapters 1 and 4) to help you build better products.
    </p>
    <div id="book-form-container">
        <form 
            class="flex flex-col gap-4 sm:flex-row sm:gap-2"
            id="book-sample-form"
            autocomplete="off"
        >
            <input 
                class="flex-1 w-full px-4 py-2 rounded-[4px] bg-white dark:bg-dark-bg focus:outline-none text-[16px] leading-[24px] tracking-[-0.01em] font-regular placeholder-[#A1A1AA] dark:placeholder-[#666666] border-0 text-black dark:text-dark-text" 
                name="email_address" 
                aria-label="Email Address" 
                placeholder="Enter your email" 
                required 
                type="email"
                id="book-email-input"
            >
            <button 
                type="submit"
                class="px-4 py-2 bg-green dark:bg-dark-accent text-white rounded-[4px] hover:bg-green/90 dark:hover:bg-dark-accent/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-[16px] leading-[24px] tracking-[-0.01em] font-medium whitespace-nowrap"
                id="book-submit-button"
            >
                <span class="button-text">{buttonText}</span>
                <span class="button-loading hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Subscribing...
                </span>
            </button>
        </form>
        <div id="book-form-message" class="mt-4 text-sm hidden"></div>
    </div>
</div>

<script>
if (typeof window !== 'undefined') {
    const form = document.getElementById('book-sample-form') as HTMLFormElement | null;
    const submitButton = document.getElementById('book-submit-button') as HTMLButtonElement | null;
    const buttonText = submitButton?.querySelector('.button-text') as HTMLElement | null;
    const buttonLoading = submitButton?.querySelector('.button-loading') as HTMLElement | null;
    const formMessage = document.getElementById('book-form-message') as HTMLDivElement | null;
    const emailInput = document.getElementById('book-email-input') as HTMLInputElement | null;
    
    let isSubmitting = false;
    let submissionTimeout: number;

    if (form && submitButton && buttonText && buttonLoading && formMessage && emailInput) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isSubmitting) return;
            isSubmitting = true;
            
            // Show loading state
            submitButton!.disabled = true;
            buttonText!.classList.add('hidden');
            buttonLoading!.classList.remove('hidden');
            formMessage.classList.add('hidden');

            // Set a timeout for user feedback
            submissionTimeout = window.setTimeout(() => {
                resetForm();
                showMessage('Subscription is taking longer than expected. Please check your email for confirmation.', 'warning');
            }, 8000);

            try {
                const formData = new FormData(form);
                
                const response = await fetch('https://app.kit.com/forms/8347970/subscriptions', {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });

                clearTimeout(submissionTimeout);

                // Since we're using no-cors, we can't read the response
                // But if no error is thrown, assume success
                
                // Track successful book sample download in Fathom
                if (typeof (window as any).fathom !== 'undefined') {
                    (window as any).fathom.trackEvent('Book Sample Download');
                }
                
                showMessage('Check your email for the download link!', 'success');
                emailInput.value = '';
                resetForm();

            } catch (error) {
                clearTimeout(submissionTimeout);
                console.error('Form submission error:', error);
                showMessage('Failed to subscribe. Please try again.', 'error');
                resetForm();
            }
        });

        function resetForm() {
            isSubmitting = false;
            submitButton!.disabled = false;
            buttonText!.classList.remove('hidden');
            buttonLoading!.classList.add('hidden');
        }

        /**
         * Show a message in the form message area.
         * @param {string} message
         * @param {'success' | 'error' | 'warning'} type
         */
        function showMessage(message: string, type: 'success' | 'error' | 'warning') {
            if (!formMessage) return;
            formMessage.textContent = message;
            formMessage.classList.remove('hidden');
            formMessage.classList.remove('text-green-600', 'dark:text-green-400', 'text-red-600', 'dark:text-red-400', 'text-yellow-600', 'dark:text-yellow-400');
            if (type === 'success') {
                formMessage.classList.add('text-green-600', 'dark:text-green-400');
            } else if (type === 'error') {
                formMessage.classList.add('text-red-600', 'dark:text-red-400');
            } else if (type === 'warning') {
                formMessage.classList.add('text-yellow-600', 'dark:text-yellow-400');
            }
        }

        submitButton.addEventListener('click', (e) => {
            if (isSubmitting) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }
}
</script> 